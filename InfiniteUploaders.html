<html>
    <head>
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-7SV03ZXJ9R"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-7SV03ZXJ9R');
        </script>
        <title>Infinite Campus</title>
        <link id="dynamic-favicon" rel="icon" type="image/png" href="https://codehs.com/uploads/f111a37947de2cea81db858094c04f2d">
        <link rel="stylesheet" href="global.css">
        <meta name="keywords" content="Infinite campus,infinite campus,Infinite Campus,infinite Campus">
        <meta name="description" content="Infinite Campus Is A International Buisiness And Has Good Devs">
        <meta property="og:title" content="Infinite Campus">
        <meta property="og:description" content="Infinite Campus Is An International Buisiness And Has Good Devs">
        <meta property="og:url" content="https://ryann-4.github.io/InfiniteCampus/">
        <meta name="theme-color" content="#8cbe37">
        <meta content="https://codehs.com/uploads/30883de2def50482be6e6fb25ea68477" property="og:image">
        <script src="main.js"></script>
        <script src="drypopup.js"></script>
        <script src="theme.js"></script>
        <style>
            #progressContainer {
                width: 80vw;
                background-color: #333;
                border-radius: 10px;
                margin: 20px auto;
                height: 20px;
                display: none;
                overflow: hidden;
            }
            #progressBar {
                width: 0%;
                height: 100%;
                background-color: limegreen;
                border-radius: 10px;
                transition: width 0.2s;
            }
        </style>
    </head>
    <body>
        <!-- Main app container -->
            <center>
                <br><br><br><br>
                <div id="app">
                    <h2 class="tptxt">5 Min File Link</h2>
                </div>
                
            </center>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
            import { getDatabase, ref, get, set, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

            const firebaseConfig = {
                apiKey: "AIzaSyDROtdBgyU_IM2xQ0ymkG8mFzjR5MjGTRQ",
                authDomain: "media-saver-aa51c.firebaseapp.com",
                projectId: "media-saver-aa51c",
                storageBucket: "media-saver-aa51c.appspot.com",
                messagingSenderId: "6224876935",
                appId: "1:6224876935:web:ffaf530c99365e910caf22",
                databaseURL: "https://media-saver-aa51c-default-rtdb.firebaseio.com/"
            };

            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);

            const params = new URLSearchParams(window.location.search);
            const fileId = params.get("id");
            const MAX_SIZE = 500 * 1024 * 1024;
            const CHUNK_SIZE = 512 * 1024;

            if (fileId) {
                document.getElementById("app").innerHTML = `
                    <center>
                        <br><br><br><br>
                        <h2 class="tptxt">Loading File...</h2>
                        <div id="progressContainer"><div id="progressBar"></div></div>
                        <p id="statusText">Fetching File Chunks...</p>
                    </center>
                `;

                const progressBar = document.getElementById("progressBar");
                const progressContainer = document.getElementById("progressContainer");
                const statusText = document.getElementById("statusText");
                progressContainer.style.display = "block";

                get(ref(db, "files/" + fileId)).then(async snapshot => {
                    if (!snapshot.exists()) {
                        document.getElementById("app").innerHTML = `
                            <center><br><br><br><br>
                            <h2 class="tptxt">File Expired Or Not Found.</h2>
                            </center>`;
                        return;
                    }
                    const fileData = snapshot.val();
                    const chunks = fileData.chunks || {};
                    const keys = Object.keys(chunks).sort((a, b) => parseInt(a) - parseInt(b));
                    let base64Data = "";
                    for (let i = 0; i < keys.length; i++) {
                        base64Data += chunks[keys[i]];
                        progressBar.style.width = Math.round(((i + 1) / keys.length) * 100) + "%";
                        statusText.textContent = `Loading Chunk ${i+1} Of ${keys.length}...`;
                        await new Promise(r => setTimeout(r, 0));
                    }

                    const a = document.createElement("a");
                    a.href = base64Data;
                    a.download = fileData.meta.name;

                    const btn = document.createElement("button");
                    btn.textContent = "Download " + fileData.meta.name;
                    btn.className = "button";
                    btn.style.textAlign = "center";
                    btn.onclick = () => a.click();

                    const uploadedAt = new Date(fileData.meta.createdAt).toLocaleString();
                    document.getElementById("app").innerHTML = `
                        <center>
                            <br><br><br><br>
                            <h2 class="tptxt">Your File Is Ready</h2>
                            <p><strong>File:</strong> ${fileData.meta.name}</p>
                            <p><strong>Uploaded:</strong> ${uploadedAt}</p>
                            </center>
                    `;
                    document.getElementById("app").appendChild(btn);
                }).catch(e => {
                    document.getElementById("app").innerHTML = "<h2>Error Loading File.</h2>";
                    console.error(e);
                });

            } else {
                document.getElementById("app").innerHTML = `
                    <center>
                        <br><br><br><br>
                        <h2 class="tptxt">Upload A File â†’ Get A 5+ Minute Download Link</h2>
                        <input type="file" id="fileInput">
                        <label for="fileInput" class="custom-file-upload">Choose File</label>
                        <p id="fileName"></p>
                        <div id="progressContainer"><div id="progressBar"></div></div>
                        <p id="output"></p>
                    </center>
                `;

                const input = document.getElementById("fileInput");
                const fileNameDisplay = document.getElementById("fileName");
                const progressBar = document.getElementById("progressBar");
                const progressContainer = document.getElementById("progressContainer");
                const output = document.getElementById("output");

                input.addEventListener("change", () => {
                    const file = input.files[0];
                    if (!file) return;

                    fileNameDisplay.textContent = "Selected File: " + file.name;

                    if (file.size > MAX_SIZE) {
                        alert("File Too Large! Maximum Allowed Size Is 500 MB.");
                        input.value = "";
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = async () => {
                        const base64Data = reader.result;
                        const id = "file_" + Date.now();
                        await set(ref(db, `files/${id}/meta`), { name: file.name, createdAt: Date.now() });

                        let index = 0;
                        progressContainer.style.display = "block";
                        for (let i = 0; i < base64Data.length; i += CHUNK_SIZE) {
                            const chunk = base64Data.substring(i, i + CHUNK_SIZE);
                            await set(ref(db, `files/${id}/chunks/${index}`), chunk);
                            index++;
                            progressBar.style.width = Math.round((i / base64Data.length) * 100) + "%";
                        }

                        await set(ref(db, `files/${id}/clicks`), 0);
                        setTimeout(() => remove(ref(db, "files/" + id)), 5 * 60 * 1000);

                        const link = `${window.location.origin}${window.location.pathname}?id=${id}`;
                        output.innerHTML = `
                            <center>
                                <br><br><br><br>
                                <p>Temporary Link (5+ Mins):</p>
                                <input type="text" id="fileLink" value="${link}" readonly style="width:80%">
                                <button class="button" onclick="copyLink()">Copy</button>
                            </center>
                        `;
                    };
                    reader.readAsDataURL(file);
                });

                window.copyLink = () => {
                    const link = document.getElementById("fileLink");
                    link.select();
                    document.execCommand("copy");
                    alert("Copied To Clipboard!");
                };
            }
        </script>

        <script src="frame.js"></script>
    </body>
</html>
