<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Realtime Data Viewer</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCUdhMpGKx5wgTGChO5y6lD6Hj3j1JKVUM",
      authDomain: "websitestats-b7d1a.firebaseapp.com",
      databaseURL: "https://websitestats-b7d1a-default-rtdb.firebaseio.com",
      projectId: "websitestats-b7d1a",
      storageBucket: "websitestats-b7d1a.firebasestorage.app",
      messagingSenderId: "379238712007",
      appId: "1:379238712007:web:cf481fbade6d1f60f5f4e2"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Helper: find most common item in an array
    function getMostCommon(arr) {
      const counts = {};
      arr.forEach(v => {
        if (!v) return;
        counts[v] = (counts[v] || 0) + 1;
      });
      let maxKey = null, maxCount = 0;
      for (const [key, count] of Object.entries(counts)) {
        if (count > maxCount) {
          maxKey = key;
          maxCount = count;
        }
      }
      return maxKey ? `${maxKey} (${maxCount})` : "None";
    }

    function renderData(dataObj) {
      const tableBody = document.getElementById("data-body");
      tableBody.innerHTML = "";

      const dataList = Object.values(dataObj || {});
      dataList.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.savedInput || ""}</td>
          <td>${item.chatLoggedIn || ""}</td>
          <td>${item.useGradient || ""}</td>
          <td>${item.city || ""}</td>
          <td>${item.state || ""}</td>
          <td>${item.timestamp ? new Date(item.timestamp).toLocaleString() : ""}</td>
        `;
        tableBody.appendChild(row);
      });

      // Update "most common" section
      document.getElementById("common-savedInput").textContent = getMostCommon(dataList.map(d => d.savedInput));
      document.getElementById("common-city").textContent = getMostCommon(dataList.map(d => d.city));
      document.getElementById("common-state").textContent = getMostCommon(dataList.map(d => d.state));
      document.getElementById("common-gradient").textContent = getMostCommon(dataList.map(d => d.useGradient));
    }

    window.addEventListener("DOMContentLoaded", () => {
      const dataRef = ref(db, "collectedData");
      onValue(dataRef, snapshot => {
        renderData(snapshot.val());
      });
    });
  </script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    .summary { margin-top: 20px; background: #f9f9f9; padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>Realtime Collected Data Viewer</h1>

  <h2>Most Common Values (Live)</h2>
  <div class="summary">
    <p><b>Saved Input:</b> <span id="common-savedInput"></span></p>
    <p><b>City:</b> <span id="common-city"></span></p>
    <p><b>State:</b> <span id="common-state"></span></p>
    <p><b>Use Gradient:</b> <span id="common-gradient"></span></p>
  </div>

  <h2>All Entries</h2>
  <table>
    <thead>
      <tr>
        <th>Saved Input</th>
        <th>Chat Logged In</th>
        <th>Use Gradient</th>
        <th>City</th>
        <th>State</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody id="data-body"></tbody>
  </table>
</body>
</html>
