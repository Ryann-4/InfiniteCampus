<html>
    <head>
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-7SV03ZXJ9R">
        </script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-7SV03ZXJ9R');
        </script>
        <title>
            Infinite Campus
        </title>
        <link id="dynamic-favicon" rel="icon" type="image/png" href="https://codehs.com/uploads/f111a37947de2cea81db858094c04f2d">
        <link rel="stylesheet" href="global.css">
        <meta name="keywords" content="Infinite campus,infinite campus,Infinite Campus,infinite Campus">
        <meta name="description" content="Infinite Campus Is A International Buisiness And Has Good Devs">
        <meta property="og:title" content="Infinite Campus">
        <meta property="og:description" content="Infinite Campus Is An International Buisiness And Has Good Devs">
        <meta property="og:url" content="https://ryann-4.github.io/InfiniteCampus/">
        <meta name="theme-color" content="#8cbe37">
        <meta content="https://codehs.com/uploads/30883de2def50482be6e6fb25ea68477" property="og:image">
        <script src="main.js">
        </script>
        <script src="drypopup.js">
        </script>
        <script src="theme.js">
        </script>
    </head>
    <body>
        <center>
            <br>
            <br>
            <br>
            <br>
            <h1 class="tptxt">
                Live Discord Chat
            </h1>
    <select id="channelSelector" class="button">
        <option value="1309160050904006696">General</option>
      <option value="1334376148087603294">Rules</option>
      <option value="1334377158789042226">Suggestions</option>
      <option value="1334377258609147967">Event</option>
      <option value="1336026895405551667">Site Updates</option>
      <option value="1389630067457527879">Website Chat</option>
      <option value="1392882466351616153">Welcome</option>
      <option value="1309164699417448550">Memes</option>
      <option value="1007051892821594183">Advertisements</option>
      <option value="1086362556203028540">Gaming</option>
      <option value="1334945403912720586">Support</option>
      <option value="1391898825588740108">AI Chat</option>
    </select>
    <form id="sendForm">
      <input class="button" type="text" id="nameInput" placeholder="Your name" required />
      <br>
      <input class="button" type="text" id="msgInput" placeholder="Type your message..." required />
      <br>
      <button class="button" type="submit">Send</button>
    </form>
    <form id="uploadForm" enctype="multipart/form-data" style="margin-top:10px;">
      <input type="file" id="fileInput" name="file" accept="image/*" required />
      <button class="button" type="submit">Upload Image</button>
    </form>
  </center>
  <ul id="messages"></ul>
  <footer>
    <p>Totally Made By Noah White And Not A Different Person.</p>
  </footer>
  <footer style="background-color:transparent; text-align:right;">
    <p>Pissing off your teachers since 2024</p>
  </footer>
  <script>
    const backendUrl = '';
    function getSelectedChannelId() {
      return document.getElementById('channelSelector').value;
    }
    async function fetchMessages() {
  const channelId = getSelectedChannelId();
  try {
    const res = await fetch(`${backendUrl}/api/messages?channelId=${channelId}`);
    const data = await res.json();
    const list = document.getElementById('messages');
    list.innerHTML = '';
    for (const msg of data.reverse()) {
      const li = document.createElement('li');
      const displayName = msg.member?.nick || msg.author.username;
      const avatarUrl = msg.author.avatar
        ? `https://cdn.discordapp.com/avatars/${msg.author.id}/${msg.author.avatar}.png`
        : `https://cdn.discordapp.com/embed/avatars/0.png`;
      const timestamp = new Date(msg.timestamp).toLocaleString();
      let contentWithMentions = msg.content || '';
      if (msg.mentions && msg.mentions.length > 0) {
        msg.mentions.forEach(u => {
          const name = u.nick || u.username;
          contentWithMentions = contentWithMentions.replace(new RegExp(`<@!?${u.id}>`, 'g'), `@${name}`);
        });
      }
      const imageRegex = /(https?:\/\/[^\s]+\.(png|jpg|jpeg|gif|webp))/gi;
      let imagesHTML = '';
      let match;
      while ((match = imageRegex.exec(contentWithMentions)) !== null) {
        imagesHTML += `<br><img class="message-img" src="${match[1]}" style="max-width:300px;">`;
      }
      let embedText = '';
      if (msg.embeds && msg.embeds.length > 0) {
        msg.embeds.forEach(embed => {
          if (embed.title) embedText += `\nTitle: ${embed.title}`;
          if (embed.description) embedText += `\n${embed.description}`;
          if (embed.fields && embed.fields.length > 0) {
            embed.fields.forEach(f => {
              embedText += `\n${f.name}: ${f.value}`;
            });
          }
        });
        if (embedText) embedText = `<br><div style="font-style:italic;color:#555;">${embedText}</div>`;
      }
      let attachmentsHTML = '';
      if (msg.attachments && msg.attachments.length > 0) {
        msg.attachments.forEach(att => {
          const url = att.url;
          const name = att.filename;
          const lowerName = name.toLowerCase();
          if (/\.(png|jpg|jpeg|gif|webp)$/.test(lowerName)) {
            attachmentsHTML += `<br><img class="message-img" src="${url}" alt="${name}" style="max-width:300px;">`;
          } else if (/\.(mp4|webm|mov)$/.test(lowerName)) {
            attachmentsHTML += `<br><video controls style="max-width:300px;"><source src="${url}" type="video/${lowerName.split('.').pop()}"></video>`;
          } else if (/\.(mp3|wav|ogg)$/.test(lowerName)) {
            attachmentsHTML += `<br><audio controls><source src="${url}" type="audio/${lowerName.split('.').pop()}"></audio>`;
          } else {
            attachmentsHTML += `<br><a href="${url}" download>${name}</a>`;
          }
        });
      }
      let reactionsHTML = '';
      if (msg.reactions && msg.reactions.length > 0) {
        msg.reactions.forEach(r => {
          const emoji = r.emoji.id
            ? `<img src="https://cdn.discordapp.com/emojis/${r.emoji.id}.${r.emoji.animated ? 'gif' : 'png'}" style="width:16px;height:16px;">`
            : r.emoji.name;
          reactionsHTML += `<span style="margin-right:5px;">${emoji} x${r.count}</span>`;
        });
        if (reactionsHTML) reactionsHTML = `<div style="margin-top:5px;">${reactionsHTML}</div>`;
      }
      let replyHTML = '';
      if (msg.reference) {
        try {
          const refRes = await fetch(`${backendUrl}/api/messages?channelId=${msg.reference.channel_id}&messageId=${msg.reference.message_id}`);
          const refMsg = await refRes.json();
          const refName = refMsg.member?.nick || refMsg.author.username;
          replyHTML = `<div style="font-style:italic;color:#666;">Replying to ${refName}: ${refMsg.content}</div>`;
        } catch {
          replyHTML = `<div style="font-style:italic;color:#666;">Replying to a deleted message</div>`;
        }
      }
      li.innerHTML = `
        <img src="${avatarUrl}" class="avatar" style="width:40px;height:40px;border-radius:50%;vertical-align:middle;">
        <div class="content" style="display:inline-block;vertical-align:middle;margin-left:10px;">
          <strong>${displayName}</strong>
          ${replyHTML}
          <div>${contentWithMentions}${imagesHTML}${embedText}</div>
          ${attachmentsHTML}
          ${reactionsHTML}
          <div class="timestamp" style="font-size:0.8em;color:#888;">${timestamp}</div>
        </div>
      `;
      list.prepend(li);
    }
  } catch (err) {
    console.error('Error fetching messages:', err);
  }
}
    async function sendMessage(name, content) {
      const channelId = getSelectedChannelId();
      try {
        await fetch(`${backendUrl}/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: `${name}\n${content}`, channelId })
        });
        document.getElementById('msgInput').value = '';
        document.getElementById('nameInput').value = '';
        fetchMessages();
      } catch (err) {
        console.error('Error sending message:', err);
      }
    }

    document.getElementById('uploadForm').addEventListener('submit', async e => {
      e.preventDefault();
      const channelId = getSelectedChannelId();
      const formData = new FormData();
      const file = document.getElementById('fileInput').files[0];
      formData.append('file', file);
      formData.append('channelId', channelId);
      try {
        await fetch(`${backendUrl}/upload`, {
          method: 'POST',
          body: formData
        });
        document.getElementById('fileInput').value = '';
        fetchMessages();
      } catch (err) {
        console.error('Error uploading file:', err);
      }
    });
    document.getElementById('channelSelector').addEventListener('change', fetchMessages);
    document.getElementById('sendForm').addEventListener('submit', e => {
      e.preventDefault();
      const name = document.getElementById('nameInput').value.trim();
      const msg = document.getElementById('msgInput').value.trim();
      if (name && msg) sendMessage(name, msg);
    });
    fetchMessages();
    setInterval(fetchMessages, 5000);
  </script>
</body>
</html>
